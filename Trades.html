<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Untitled Page</title>
<meta name="generator" content="WYSIWYG Web Builder 20 - https://www.wysiwygwebbuilder.com">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="delta_connex.css" rel="stylesheet">
<link href="Trades.css" rel="stylesheet">
</head>
<body>
<div id="wb_LayoutGrid3">
<div id="LayoutGrid3">
<div class="col-1">
<div id="wb_LayoutGrid2">
<div id="LayoutGrid2">
<div class="col-1">
<picture id="wb_Picture1" style="display:block;width: 100%;height:38px;z-index:0">
<img src="logo.png" id="Picture1" alt="" width="39" height="34">
</picture>
</div>
<div class="col-2">
<hr id="HorizontalLine1" style="display:inline-block;width:216px;z-index:1;">
<div id="wb_Text1">
<span style="color:#000000;font-family:Arial;font-size:16px;"><strong>DELTA CONNEX</strong></span>
</div>
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="FlexContainer1">
<button type="submit" id="ThemeableButton3" name="" value="Money" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:4;">Money</button>
<button type="submit" id="ThemeableButton4" name="" value="Percentage" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:5;">Percentage</button>
</div>
</div>
<div class="col-3">
</div>
</div>
</div>
<div id="wb_LayoutGrid5">
<div id="LayoutGrid5">
<div class="row">
<div class="col-1">
<hr id="HorizontalLine2" style="display:inline-block;width:160px;z-index:26;">
<div id="wb_LayoutGrid6">
<div id="LayoutGrid6">
<div class="row">
<div class="col-1">
<div id="wb_Text2">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>GENERAL</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid4" onclick="window.location.href='./Dashboard.html';return false;">
<div id="LayoutGrid4">
<div class="col-1">
<div id="wb_Icon1" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:8;">
<div id="Icon1"><i class="Icon1"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button2" name="" value="Dashboard" style="display:block;width: 100%;;height:19px;z-index:9;">
</div>
</div>
</div>
<div id="wb_LayoutGrid7" onclick="window.location.href='./Calendar.html';return false;">
<div id="LayoutGrid7">
<div class="col-1">
<div id="wb_Icon2" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:10;">
<div id="Icon2"><i class="Icon2"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button1" name="" value="Calendar  " style="display:block;width: 100%;;height:19px;z-index:11;">
</div>
</div>
</div>
<div id="wb_LayoutGrid1" onclick="window.location.href='./Account.html';return false;">
<div id="LayoutGrid1">
<div class="col-1">
<div id="wb_Icon3" style="display:inline-block;width:14px;height:25px;text-align:center;z-index:12;">
<div id="Icon3"><i class="Icon3"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button3" name="" value="Accounts   " style="display:block;width: 100%;;height:19px;z-index:13;">
</div>
</div>
</div>
<div id="wb_LayoutGrid8">
<div id="LayoutGrid8">
<div class="row">
<div class="col-1">
<div id="wb_Text8">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>TRADING</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid10" onclick="window.location.href='./Trades.html';return false;">
<div id="LayoutGrid10">
<div class="col-1">
<div id="wb_Icon5" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:15;">
<div id="Icon5"><i class="Icon5"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button4" name="" value="Trades   " style="display:block;width: 100%;;height:19px;z-index:16;">
</div>
</div>
</div>
<div id="wb_LayoutGrid11" onclick="window.location.href='./Analytics.html';return false;">
<div id="LayoutGrid11">
<div class="col-1">
<div id="wb_Icon6" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:17;">
<div id="Icon6"><i class="Icon6"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button5" name="" value="Analytics " style="display:block;width: 100%;;height:19px;z-index:18;">
</div>
</div>
</div>
<div id="wb_LayoutGrid9" onclick="window.location.href='./Progress-Tracker.html';return false;">
<div id="LayoutGrid9">
<div class="col-1">
<div id="wb_Icon4" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:19;">
<div id="Icon4"><i class="Icon4"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button6" name="" value="Progress Tracker " style="display:block;width: 100%;;height:19px;z-index:20;">
</div>
</div>
</div>
<div id="wb_LayoutGrid12">
<div id="LayoutGrid12">
<div class="row">
<div class="col-1">
<div id="wb_Text12">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>STRATEGY</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid13" onclick="window.location.href='./Strategies.html';return false;">
<div id="LayoutGrid13">
<div class="col-1">
<div id="wb_Icon7" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:22;">
<div id="Icon7"><i class="Icon7"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button7" name="" value="Strategies" style="display:block;width: 100%;;height:19px;z-index:23;">
</div>
</div>
</div>
<div id="wb_LayoutGrid14" onclick="window.location.href='./Backtesting.html';return false;">
<div id="LayoutGrid14">
<div class="col-1">
<div id="wb_Icon8" style="display:inline-block;width:14px;height:21px;text-align:center;z-index:24;">
<div id="Icon8"><i class="Icon8"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button8" name="" value="Backtesting" style="display:block;width: 100%;;height:19px;z-index:25;">
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="wb_LayoutGrid16">
<div id="LayoutGrid16">
<div class="col-1">
<div id="wb_LayoutGrid15">
<div id="LayoutGrid15">
<div class="row">
<div class="col-1">
<div id="wb_Text3">
<span style="color:#000000;font-family:Arial;font-size:21px;"><strong>Trading History</strong></span>
</div>
<div id="wb_Text15">
<span style="color:#696969;font-family:Arial;font-size:13px;">View and manage your trades</span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid19">
<div id="LayoutGrid19">
<div class="col-1">
<div id="Html1" style="display:inline-block;width:100%;height:1929px;overflow:auto;z-index:40">
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Cuentas MT5</title>
  </head>
<body>
  <div id="dashboard"></div>
  
  <script>
    // Función para calcular ganancias consecutivas máximas
    function calculateConsecutiveWins(history) {
      if (!history || history.length === 0) return 0;
      
      let maxWins = 0;
      let currentWins = 0;
      
      // Ordenar por tiempo para asegurar el orden correcto
      const sortedHistory = [...history].sort((a, b) => a.time - b.time);
      
      for (let trade of sortedHistory) {
        if (trade.profit > 0) {
          currentWins++;
          maxWins = Math.max(maxWins, currentWins);
        } else if (trade.profit < 0) {
          currentWins = 0;
        }
        // Si profit === 0, no afecta la racha (mantiene currentWins)
      }
      
      return maxWins;
    }

    // Función para calcular pérdidas consecutivas máximas
    function calculateConsecutiveLosses(history) {
      if (!history || history.length === 0) return 0;
      
      let maxLosses = 0;
      let currentLosses = 0;
      
      // Ordenar por tiempo para asegurar el orden correcto
      const sortedHistory = [...history].sort((a, b) => a.time - b.time);
      
      for (let trade of sortedHistory) {
        if (trade.profit < 0) {
          currentLosses++;
          maxLosses = Math.max(maxLosses, currentLosses);
        } else if (trade.profit > 0) {
          currentLosses = 0;
        }
        // Si profit === 0, no afecta la racha (mantiene currentLosses)
      }
      
      return maxLosses;
    }

    // Función para calcular total de operaciones positivas
    function calculateTotalPositives(history) {
      if (!history || history.length === 0) return 0;
      
      let totalPositives = 0;
      for (let trade of history) {
        if (trade.profit > 0) {
          totalPositives++;
        }
      }
      
      return totalPositives;
    }

    // Función para calcular total de operaciones negativas
    function calculateTotalNegatives(history) {
      if (!history || history.length === 0) return 0;
      
      let totalNegatives = 0;
      for (let trade of history) {
        if (trade.profit < 0) {
          totalNegatives++;
        }
      }
      
      return totalNegatives;
    }

    // Función para calcular P&L mensual
    function calculateMonthlyPL(history, balance) {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let monthlyProfit = 0;
      let initialBalance = balance;
      
      for (let trade of history) {
        const tradeDate = new Date(trade.time * 1000);
        if (tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear) {
          monthlyProfit += trade.profit;
          initialBalance -= trade.profit;
        }
      }
      
      const percentage = initialBalance > 0 ? (monthlyProfit / initialBalance) * 100 : 0;
      return percentage;
    }

    async function fetchData() {
      try {
        const res = await fetch("http://127.0.0.1:8000/dashboard/data");
        const data = await res.json();
        const container = document.getElementById("dashboard");
        container.innerHTML = "";

        if (Object.keys(data).length === 0) {
          container.innerHTML = "<p class='no-data'>📭 No hay datos aún.</p>";
          return;
        }

        Object.entries(data).forEach(([accountId, d]) => {
          // Calcular estadísticas
          const totalTrades = Array.isArray(d.history) ? d.history.length : 0;
          const consecutiveWins = totalTrades > 0 ? calculateConsecutiveWins(d.history) : 0;
          const consecutiveLosses = totalTrades > 0 ? calculateConsecutiveLosses(d.history) : 0;
          const monthlyPL = totalTrades > 0 ? calculateMonthlyPL(d.history, d.balance) : 0;
          const totalPositives = totalTrades > 0 ? calculateTotalPositives(d.history) : 0;
          const totalNegatives = totalTrades > 0 ? calculateTotalNegatives(d.history) : 0;

          // Crear tarjetas de estadísticas
          
          const statsContainer = document.createElement("div");
          statsContainer.className = "stats-container";
          
          statsContainer.innerHTML = `
          
            <div class="stat-card">
              <div class="stat-title">Win Rate</div>
              <div class="stat-value neutral">${d.metrics.win_rate}%</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Profit Factor</div>
              <div class="stat-value neutral">${d.metrics.profit_factor}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Drawdown</div>
              <div class="stat-value neutral">${d.drawdown}</div>
            </div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Total Trades</div>
              <div class="stat-value neutral">${totalTrades}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Operaciones Ganadoras</div>
              <div class="stat-value wins">${d.metrics.winning_trades}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Operaciones Perdedoras</div>
              <div class="stat-value losses">${d.metrics.losing_trades}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Consecutivas Ganadoras</div>
              <div class="stat-value wins">${consecutiveWins}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Consecutivas Perdedoras</div>
              <div class="stat-value losses">${consecutiveLosses}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Profit Neto</div>
              <div class="stat-value losses">${d.metrics.net_profit}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Total P&L (Deals)</div>
              <div class="stat-value losses">${d.metrics.total_pnl_deals}</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Month P&L</div>
              <div class="stat-value losses">${d.metrics.current_month_pnl}</div>
            </div>
          `;

          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <p><strong>🧾 Cuenta </strong> ${accountId}</p>
            <p><strong>Nombre:</strong> ${d.account_name}</p>
            <p><strong>Balance:</strong> $${Number(d.balance).toLocaleString()}</p>
          `;

          if (Array.isArray(d.history) && d.history.length > 0) {
            let tradesHTML = `
              <p><strong>📈 Historial de operaciones </strong>(${d.history.length})</p>
              <table>
                <thead>
                  <tr>
                    <th>Ticket</th>
                    <th>Símbolo</th>
                    <th>Volumen</th>
                    <th>Precio</th>
                    <th>Ganancia</th>
                    <th>Tipo</th>
                    <th>Hora</th>
                  </tr>
                </thead>
                <tbody>
            `;

            d.history.forEach(trade => {
              const tipo = trade.type === 0
                ? `<span class="type-buy">BUY</span>`
                : trade.type === 1
                ? `<span class="type-sell">SELL</span>`
                : "Otro";

              const plClass = trade.profit >= 0 ? "pl-positive" : "pl-negative";

              tradesHTML += `
                <tr>
                  <td>${trade.ticket}</td>
                  <td>${trade.symbol}</td>
                  <td>${trade.volume}</td>
                  <td>$${Number(trade.price).toFixed(5)}</td>
                  <td class="${plClass}">${trade.profit >= 0 ? "+" : "-"}$${Math.abs(trade.profit).toFixed(2)}</td>
                  <td>${tipo}</td>
                  <td>${new Date(trade.time * 1000).toLocaleString()}</td>
                </tr>
              `;
            });

            tradesHTML += `</tbody></table>`;
            card.innerHTML += tradesHTML;
          } else {
            card.innerHTML += `<p>📭 Sin historial de operaciones.</p>`;
          }

          container.appendChild(statsContainer);
          container.appendChild(card);
        });
      } catch (err) {
        console.error("❌ Error al obtener datos:", err);
        document.getElementById("dashboard").innerHTML = "<p class='error'>❌ Error de conexión al backend.</p>";
      }
    }

    setInterval(fetchData, 5000);
    fetchData();
  </script>
</body>
</html></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>