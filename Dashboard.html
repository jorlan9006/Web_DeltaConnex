<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Untitled Page</title>
<meta name="generator" content="WYSIWYG Web Builder 20 - https://www.wysiwygwebbuilder.com">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="delta_connex.css" rel="stylesheet">
<link href="Dashboard.css" rel="stylesheet">
</head>
<body>
<div id="wb_LayoutGrid3">
<div id="LayoutGrid3">
<div class="col-1">
<div id="wb_LayoutGrid2">
<div id="LayoutGrid2">
<div class="col-1">
<picture id="wb_Picture1" style="display:block;width: 100%;height:38px;z-index:0">
<img src="logo.png" id="Picture1" alt="" width="39" height="34">
</picture>
</div>
<div class="col-2">
<hr id="HorizontalLine1" style="display:inline-block;width:216px;z-index:1;">
<div id="wb_Text1">
<span style="color:#000000;font-family:Arial;font-size:16px;"><strong>DELTA CONNEX</strong></span>
</div>
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="FlexContainer1">
<button type="submit" id="ThemeableButton3" name="" value="Money" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:4;">Money</button>
<button type="submit" id="ThemeableButton4" name="" value="Percentage" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:5;">Percentage</button>
</div>
</div>
<div class="col-3">
</div>
</div>
</div>
<div id="wb_LayoutGrid5">
<div id="LayoutGrid5">
<div class="row">
<div class="col-1">
<hr id="HorizontalLine2" style="display:inline-block;width:160px;z-index:26;">
<div id="wb_LayoutGrid6">
<div id="LayoutGrid6">
<div class="row">
<div class="col-1">
<div id="wb_Text2">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>GENERAL</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid4" onclick="window.location.href='./Dashboard.html';return false;">
<div id="LayoutGrid4">
<div class="col-1">
<div id="wb_Icon1" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:8;">
<div id="Icon1"><i class="Icon1"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button2" name="" value="Dashboard" style="display:block;width: 100%;;height:19px;z-index:9;">
</div>
</div>
</div>
<div id="wb_LayoutGrid7" onclick="window.location.href='./Calendar.html';return false;">
<div id="LayoutGrid7">
<div class="col-1">
<div id="wb_Icon2" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:10;">
<div id="Icon2"><i class="Icon2"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button1" name="" value="Calendar  " style="display:block;width: 100%;;height:19px;z-index:11;">
</div>
</div>
</div>
<div id="wb_LayoutGrid1" onclick="window.location.href='./Account.html';return false;">
<div id="LayoutGrid1">
<div class="col-1">
<div id="wb_Icon3" style="display:inline-block;width:14px;height:25px;text-align:center;z-index:12;">
<div id="Icon3"><i class="Icon3"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button3" name="" value="Accounts   " style="display:block;width: 100%;;height:19px;z-index:13;">
</div>
</div>
</div>
<div id="wb_LayoutGrid8">
<div id="LayoutGrid8">
<div class="row">
<div class="col-1">
<div id="wb_Text8">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>TRADING</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid10" onclick="window.location.href='./Trades.html';return false;">
<div id="LayoutGrid10">
<div class="col-1">
<div id="wb_Icon5" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:15;">
<div id="Icon5"><i class="Icon5"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button4" name="" value="Trades   " style="display:block;width: 100%;;height:19px;z-index:16;">
</div>
</div>
</div>
<div id="wb_LayoutGrid11" onclick="window.location.href='./Analytics.html';return false;">
<div id="LayoutGrid11">
<div class="col-1">
<div id="wb_Icon6" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:17;">
<div id="Icon6"><i class="Icon6"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button5" name="" value="Analytics " style="display:block;width: 100%;;height:19px;z-index:18;">
</div>
</div>
</div>
<div id="wb_LayoutGrid9" onclick="window.location.href='./Progress-Tracker.html';return false;">
<div id="LayoutGrid9">
<div class="col-1">
<div id="wb_Icon4" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:19;">
<div id="Icon4"><i class="Icon4"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button6" name="" value="Progress Tracker " style="display:block;width: 100%;;height:19px;z-index:20;">
</div>
</div>
</div>
<div id="wb_LayoutGrid12">
<div id="LayoutGrid12">
<div class="row">
<div class="col-1">
<div id="wb_Text12">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>STRATEGY</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid13" onclick="window.location.href='./Strategies.html';return false;">
<div id="LayoutGrid13">
<div class="col-1">
<div id="wb_Icon7" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:22;">
<div id="Icon7"><i class="Icon7"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button7" name="" value="Strategies" style="display:block;width: 100%;;height:19px;z-index:23;">
</div>
</div>
</div>
<div id="wb_LayoutGrid14" onclick="window.location.href='./Backtesting.html';return false;">
<div id="LayoutGrid14">
<div class="col-1">
<div id="wb_Icon8" style="display:inline-block;width:14px;height:21px;text-align:center;z-index:24;">
<div id="Icon8"><i class="Icon8"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button8" name="" value="Backtesting" style="display:block;width: 100%;;height:19px;z-index:25;">
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="wb_LayoutGrid16">
<div id="LayoutGrid16">
<div class="col-1">
<div id="wb_LayoutGrid15">
<div id="LayoutGrid15">
<div class="row">
<div class="col-1">
<div id="wb_Text3">
<span style="color:#000000;font-family:Arial;font-size:21px;"><strong>Welcome back, Jorlan Martinez </strong></span>
</div>
<div id="wb_Text4">
<span style="color:#808080;font-family:Arial;font-size:13px;">Sunday, february 9</span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid17">
<div id="LayoutGrid17">
<div class="row">
<div class="col-1">
<div id="wb_Text16">
<span style="color:#000000;font-family:Arial;font-size:16px;"><strong>Metrics Summary</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid18">
<div id="LayoutGrid18">
<div class="col-1">
<div id="Html2" style="display:inline-block;width:100%;height:572px;overflow:auto;z-index:41">
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Cuentas MT5</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
<body>

  <div id="dashboard"></div>

  <script>
    async function fetchData() {
      try {
        const res = await fetch("http://127.0.0.1:8000/dashboard/data");
        const data = await res.json();
        const container = document.getElementById("dashboard");
        container.innerHTML = "";

        if (Object.keys(data).length === 0) {
          container.innerHTML = "<p class='no-data'>📭 No hay datos aún.</p>";
          return;
        }

        Object.entries(data).forEach(([accountId, d]) => {
          const card = document.createElement("div");
          card.className = "card";

          let totalProfit = 0, winningTrades = 0, losingTrades = 0;
          let grossProfit = 0, grossLoss = 0, totalRelevantTrades = 0;

          if (Array.isArray(d.history)) {
            d.history.forEach(trade => {
              const p = Number(trade.profit);
              if (isNaN(p)) return;
              totalProfit += p;
              if (trade.type === 0 || trade.type === 1) {
                totalRelevantTrades++;
                if (p > 0) { winningTrades++; grossProfit += p; }
                else if (p < 0) { losingTrades++; grossLoss += -p; }
              }
            });
          }

          const winRate = totalRelevantTrades > 0
            ? ((winningTrades / totalRelevantTrades) * 100).toFixed(1) + "%"
            : "0.0%";
          const profitFactor = grossLoss > 0
            ? (grossProfit / grossLoss).toFixed(2)
            : (grossProfit > 0 ? "∞" : "0.00");
          const formattedPnl = totalProfit >= 0
            ? `+$${totalProfit.toFixed(2)}`
            : `-$${Math.abs(totalProfit).toFixed(2)}`;
          const pnlClass = totalProfit >= 0 ? "pl-positive" : "pl-negative";

          const chartId = `chart-${accountId.replace(/[^a-zA-Z0-9]/g, '')}`;

          card.innerHTML = `
            <p><strong>Cuenta:</strong> ${accountId}</p>
            <p><strong>Nombre:</strong> ${d.account_name}</p>
            <p><strong>Balance:</strong> $${Number(d.balance).toLocaleString()}</p>

            <div class="summary-cards">
              <div class="summary-card">
                <h3>$ Total P&L</h3>
                <div class="value ${pnlClass}">${formattedPnl}</div>
                <div>Overall performance</div>
              </div>
              <div class="summary-card">
                <h3>Win Rate</h3>
                <div class="value">${winRate}</div>
                <div>Success ratio</div>
              </div>
              <div class="summary-card">
                <h3>Profit Factor</h3>
                <div class="value">${profitFactor}</div>
                <div>Risk/Reward efficiency</div>
              </div>
            </div>

            <div class="chart-wrapper">
              <canvas id="${chartId}"></canvas>
            </div>
          `;

          container.appendChild(card);

          if (Array.isArray(d.history) && d.history.length > 0) {
            const sortedTrades = d.history
              .filter(t => !isNaN(t.time) && !isNaN(t.profit))
              .sort((a, b) => a.time - b.time);

            let labels = [];
            let balanceData = [];

            let balance = d.balance;
            for (let i = sortedTrades.length - 1; i >= 0; i--) {
              balance -= Number(sortedTrades[i].profit);
            }

            let runningBalance = balance;
            sortedTrades.forEach(trade => {
              runningBalance += Number(trade.profit);
              labels.push(new Date(trade.time * 1000).toLocaleDateString());
              balanceData.push(runningBalance.toFixed(2));
            });

            const ctx = document.getElementById(chartId).getContext("2d");
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Balance',
                  data: balanceData,
                  fill: true,
                  backgroundColor: 'rgba(0, 200, 255, 0.1)',
                  borderColor: '#00bcd4',
                  tension: 0.4,
                  pointRadius: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  x: {
                    ticks: {
                      color: '#666',
                      font: {
                        family: 'Arial',
                        size: 11
                      }
                    }
                  },
                  y: {
                    ticks: {
                      color: '#666',
                      font: {
                        family: 'Arial',
                        size: 11
                      },
                      callback: val => `$${val}`
                    },
                    grid: {
                      color: 'rgba(0,0,0,0.05)'
                    }
                  }
                }
              }
            });
          }
        });
      } catch (err) {
        console.error("❌ Error al obtener datos:", err);
        document.getElementById("dashboard").innerHTML = "<p class='error'>❌ Error de conexión al backend.</p>";
      }
    }

    fetchData();
    setInterval(fetchData, 300000); // 5 minutos
  </script>
</body>
</html>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>