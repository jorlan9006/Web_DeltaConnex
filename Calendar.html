<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Untitled Page</title>
<meta name="generator" content="WYSIWYG Web Builder 20 - https://www.wysiwygwebbuilder.com">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="delta_connex.css" rel="stylesheet">
<link href="Calendar.css" rel="stylesheet">
</head>
<body>
<div id="wb_LayoutGrid3">
<div id="LayoutGrid3">
<div class="col-1">
<div id="wb_LayoutGrid2">
<div id="LayoutGrid2">
<div class="col-1">
<picture id="wb_Picture1" style="display:block;width: 100%;height:38px;z-index:0">
<img src="logo.png" id="Picture1" alt="" width="39" height="34">
</picture>
</div>
<div class="col-2">
<hr id="HorizontalLine1" style="display:inline-block;width:216px;z-index:1;">
<div id="wb_Text1">
<span style="color:#000000;font-family:Arial;font-size:16px;"><strong>DELTA CONNEX</strong></span>
</div>
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="FlexContainer1">
<button type="submit" id="ThemeableButton3" name="" value="Money" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:4;">Money</button>
<button type="submit" id="ThemeableButton4" name="" value="Percentage" class="ui-button ui-corner-all" style="display:block;width:74px;height:22px;z-index:5;">Percentage</button>
</div>
</div>
<div class="col-3">
</div>
</div>
</div>
<div id="wb_LayoutGrid5">
<div id="LayoutGrid5">
<div class="row">
<div class="col-1">
<hr id="HorizontalLine2" style="display:inline-block;width:160px;z-index:26;">
<div id="wb_LayoutGrid6">
<div id="LayoutGrid6">
<div class="row">
<div class="col-1">
<div id="wb_Text2">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>GENERAL</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid4" onclick="window.location.href='./Dashboard.html';return false;">
<div id="LayoutGrid4">
<div class="col-1">
<div id="wb_Icon1" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:8;">
<div id="Icon1"><i class="Icon1"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button2" name="" value="Dashboard" style="display:block;width: 100%;;height:19px;z-index:9;">
</div>
</div>
</div>
<div id="wb_LayoutGrid7" onclick="window.location.href='./Calendar.html';return false;">
<div id="LayoutGrid7">
<div class="col-1">
<div id="wb_Icon2" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:10;">
<div id="Icon2"><i class="Icon2"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button1" name="" value="Calendar  " style="display:block;width: 100%;;height:19px;z-index:11;">
</div>
</div>
</div>
<div id="wb_LayoutGrid1" onclick="window.location.href='./Account.html';return false;">
<div id="LayoutGrid1">
<div class="col-1">
<div id="wb_Icon3" style="display:inline-block;width:14px;height:25px;text-align:center;z-index:12;">
<div id="Icon3"><i class="Icon3"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button3" name="" value="Accounts   " style="display:block;width: 100%;;height:19px;z-index:13;">
</div>
</div>
</div>
<div id="wb_LayoutGrid8">
<div id="LayoutGrid8">
<div class="row">
<div class="col-1">
<div id="wb_Text8">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>TRADING</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid10" onclick="window.location.href='./Trades.html';return false;">
<div id="LayoutGrid10">
<div class="col-1">
<div id="wb_Icon5" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:15;">
<div id="Icon5"><i class="Icon5"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button4" name="" value="Trades   " style="display:block;width: 100%;;height:19px;z-index:16;">
</div>
</div>
</div>
<div id="wb_LayoutGrid11" onclick="window.location.href='./Analytics.html';return false;">
<div id="LayoutGrid11">
<div class="col-1">
<div id="wb_Icon6" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:17;">
<div id="Icon6"><i class="Icon6"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button5" name="" value="Analytics " style="display:block;width: 100%;;height:19px;z-index:18;">
</div>
</div>
</div>
<div id="wb_LayoutGrid9" onclick="window.location.href='./Progress-Tracker.html';return false;">
<div id="LayoutGrid9">
<div class="col-1">
<div id="wb_Icon4" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:19;">
<div id="Icon4"><i class="Icon4"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button6" name="" value="Progress Tracker " style="display:block;width: 100%;;height:19px;z-index:20;">
</div>
</div>
</div>
<div id="wb_LayoutGrid12">
<div id="LayoutGrid12">
<div class="row">
<div class="col-1">
<div id="wb_Text12">
<span style="color:#424851;font-family:Arial;font-size:13px;"><strong>STRATEGY</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid13" onclick="window.location.href='./Strategies.html';return false;">
<div id="LayoutGrid13">
<div class="col-1">
<div id="wb_Icon7" style="display:inline-block;width:14px;height:22px;text-align:center;z-index:22;">
<div id="Icon7"><i class="Icon7"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button7" name="" value="Strategies" style="display:block;width: 100%;;height:19px;z-index:23;">
</div>
</div>
</div>
<div id="wb_LayoutGrid14" onclick="window.location.href='./Backtesting.html';return false;">
<div id="LayoutGrid14">
<div class="col-1">
<div id="wb_Icon8" style="display:inline-block;width:14px;height:21px;text-align:center;z-index:24;">
<div id="Icon8"><i class="Icon8"></i></div>
</div>
</div>
<div class="col-2">
<input type="submit" id="Button8" name="" value="Backtesting" style="display:block;width: 100%;;height:19px;z-index:25;">
</div>
</div>
</div>
</div>
<div class="col-2">
<div id="wb_LayoutGrid16">
<div id="LayoutGrid16">
<div class="col-1">
<div id="wb_LayoutGrid15">
<div id="LayoutGrid15">
<div class="row">
<div class="col-1">
<div id="wb_Text3">
<span style="color:#000000;font-family:Arial;font-size:21px;"><strong>Trading Calendar</strong></span>
</div>
<div id="wb_Text15">
<span style="color:#696969;font-family:Arial;font-size:13px;"><strong>Weekly Performance</strong></span>
</div>
</div>
</div>
</div>
</div>
<div id="wb_LayoutGrid19">
<div id="LayoutGrid19">
<div class="col-1">
<div id="Html1" style="display:inline-block;width:100%;height:960px;overflow:auto;z-index:40">
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard y Calendario de Trading MT5</title>
  </head>
<body>
  <div id="dashboard"></div>

  <script>
    const calendarStates = {};
    const ALL_TRADES_DATA = {}; 

    // --- FUNCIÓN DE PROCESAMIENTO SIMPLIFICADA ---
    function processTradeHistoryForCalendar(history) {
        const dailyStats = new Map();
        if (!history || history.length === 0) {
            return { dailyStats: new Map(), weeklyStats: [] };
        }

        // Agrupar trades y sumar profit por día
        history.forEach(trade => {
            const tradeDate = new Date(trade.time * 1000);
            const dayKey = tradeDate.toISOString().split('T')[0]; // 'YYYY-MM-DD'
            
            if (!dailyStats.has(dayKey)) {
                dailyStats.set(dayKey, { profit: 0, trades: 0 });
            }
            
            const dayData = dailyStats.get(dayKey);
            dayData.profit += trade.profit;
            dayData.trades += 1;
        });

        // Calcular resumen semanal a partir de los datos diarios
        const weeklyStatsMap = new Map();
        dailyStats.forEach((stats, dayKey) => {
            const date = new Date(dayKey);
            const weekNumber = getWeekNumber(date);
            const year = date.getFullYear();
            const weekKey = `${year}-W${weekNumber}`;
            
            if (!weeklyStatsMap.has(weekKey)) {
                weeklyStatsMap.set(weekKey, { week: weekNumber, profit: 0, trades: 0 });
            }

            const weekData = weeklyStatsMap.get(weekKey);
            weekData.profit += stats.profit;
            weekData.trades += stats.trades;
        });
        
        const weeklyStats = Array.from(weeklyStatsMap.values());
        return { dailyStats, weeklyStats };
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    
    // --- FUNCIÓN DE RENDERIZADO ACTUALIZADA ---
    function renderCalendar(accountId) {
        const { date, dailyStats, weeklyStats } = calendarStates[accountId];
        const wrapper = document.getElementById(`calendar-wrapper-${accountId}`);
        if (!wrapper) return;

        const month = date.getMonth();
        const year = date.getFullYear();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthName = date.toLocaleString('es-ES', { month: 'long' });

        let html = `
            <div class="calendar-header">
                <h3>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}</h3>
                <div class="calendar-nav">
                    <button id="prev-month-${accountId}">‹ Previous</button>
                    <button id="next-month-${accountId}">Next ›</button>
                </div>
            </div>
            <div class="calendar-main">
                <div class="calendar-grid">
                    ${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].map(name => `<div class="calendar-day-name">${name}</div>`).join('')}
        `;

        for (let i = 0; i < firstDay; i++) {
            html += `<div class="calendar-day empty"></div>`;
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const stats = dailyStats.get(dayKey);
            html += `<div class="calendar-day"><div class="day-number">${i}</div>`;
            if (stats) {
                // ** CAMBIO: Mostrar ganancia en dinero, no en porcentaje **
                const pnlClass = stats.profit >= 0 ? 'positive' : 'negative';
                html += ` <div class="day-pnl ${pnlClass}">
                              ${stats.profit >= 0 ? '+' : '-'}$${Math.abs(stats.profit).toFixed(2)}
                          </div>
                          <div class="day-trades">${stats.trades} trade${stats.trades > 1 ? 's' : ''}</div>`;
            }
            html += `</div>`;
        }
        html += `</div><div class="weekly-summary" id="weekly-summary-${accountId}"></div></div>`;
        wrapper.innerHTML = html;

        // Renderizar resumen semanal
        const weeklySummaryContainer = document.getElementById(`weekly-summary-${accountId}`);
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month, daysInMonth);
        const currentWeeks = weeklyStats.filter(w => {
            const weekNo = getWeekNumber(new Date(year, 0, (w.week - 1) * 7 + 1));
            return weekNo >= getWeekNumber(firstDayOfMonth) && weekNo <= getWeekNumber(lastDayOfMonth);
        }).sort((a,b) => a.week - b.week);
        
        let weeklyHtml = '';
        currentWeeks.forEach(week => {
             // ** CAMBIO: Mostrar ganancia semanal en dinero **
           
        });
        weeklySummaryContainer.innerHTML = weeklyHtml;

        document.getElementById(`prev-month-${accountId}`).addEventListener('click', () => {
            calendarStates[accountId].date.setMonth(calendarStates[accountId].date.getMonth() - 1);
            renderCalendar(accountId);
        });
        document.getElementById(`next-month-${accountId}`).addEventListener('click', () => {
            calendarStates[accountId].date.setMonth(calendarStates[accountId].date.getMonth() + 1);
            renderCalendar(accountId);
        });
    }

    async function fetchData() {
      try {
        const res = await fetch("http://127.0.0.1:8000/dashboard/data");
        const data = await res.json();
        const dashboardContainer = document.getElementById("dashboard");

        if (Object.keys(data).length === 0) {
          dashboardContainer.innerHTML = "<p class='no-data'>📭 No hay datos aún.</p>";
          return;
        }

        Object.entries(data).forEach(([accountId, d]) => {
            ALL_TRADES_DATA[accountId] = d;
            let accountContainer = document.getElementById(`account-container-${accountId}`);
            
            if (!accountContainer) {
                accountContainer = document.createElement("div");
                accountContainer.id = `account-container-${accountId}`;
                accountContainer.className = "account-container";
                accountContainer.innerHTML = `
                    <h2 class="account-title">Cuenta ${d.account_name} (${accountId})</h2>
                    <div class="stats-container" id="stats-container-${accountId}"></div>
                    <div class="calendar-wrapper" id="calendar-wrapper-${accountId}"></div>
                `;
                dashboardContainer.appendChild(accountContainer);
                calendarStates[accountId] = { date: new Date() };
            }
            
            const statsContainer = document.getElementById(`stats-container-${accountId}`);
            const history = Array.isArray(d.history) ? d.history : [];
            const totalTrades = history.length;
            const totalPositives = history.filter(t => t.profit > 0).length;
            const totalNegatives = history.filter(t => t.profit < 0).length;
            const today = new Date();
            const todaysProfit = history
                .filter(trade => {
                    const tradeDate = new Date(trade.time * 1000);
                    return tradeDate.getDate() === today.getDate() &&
                           tradeDate.getMonth() === today.getMonth() &&
                           tradeDate.getFullYear() === today.getFullYear();
                })
                .reduce((sum, trade) => sum + trade.profit, 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">P&L de Hoy</div>
                    <div class="stat-value ${todaysProfit >= 0 ? 'positive' : 'negative'}">
                        ${todaysProfit >= 0 ? '+' : ''}$${Math.abs(todaysProfit).toFixed(2)}
                    </div>
                </div>
                <div class="stat-card"><div class="stat-title">Total Trades</div><div class="stat-value neutral">${totalTrades}</div></div>
                <div class="stat-card"><div class="stat-title">Total Positives</div><div class="stat-value wins">${totalPositives}</div></div>
                <div class="stat-card"><div class="stat-title">Total Negatives</div><div class="stat-value losses">${totalNegatives}</div></div>
            `;

            // Llamada a la función simplificada
            const { dailyStats, weeklyStats } = processTradeHistoryForCalendar(history);
            calendarStates[accountId].dailyStats = dailyStats;
            calendarStates[accountId].weeklyStats = weeklyStats;
            
            renderCalendar(accountId);
        });

      } catch (err) {
        console.error("❌ Error al obtener datos:", err);
        document.getElementById("dashboard").innerHTML = "<p class='error'>❌ Error de conexión al backend.</p>";
      }
    }

    setInterval(fetchData, 5000);
    fetchData();
  </script>
</body>
</html></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>